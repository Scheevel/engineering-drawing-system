# Story 3.3: Schema Creation and Basic Editing

## Status
Approved

## Story
**As a** railroad bridge engineer,
**I want** to create and edit component type schemas for my projects,
**so that** I can define the data structure that best fits my project's component requirements.

## Acceptance Criteria

1. **Schema Creation Dialog Implementation**
   - Modal dialog accessible from schema list with "Create Schema" button
   - Form fields: name (required), description (optional), project selection
   - Support both global schema creation and project-specific creation
   - Form validation with real-time feedback
   - Consistent with existing application modal patterns

2. **Schema Name Validation**
   - Validate schema name uniqueness within project scope
   - Prevent duplicate names with clear error messaging
   - Minimum and maximum length validation (3-100 characters)
   - Alphanumeric + common characters allowed, prevent special characters
   - Real-time validation feedback during typing

3. **Project Context Handling**
   - When creating from project context, automatically set project_id
   - Global schema creation when accessed from `/schemas` route
   - Clear indication of schema scope (global vs project-specific)
   - Project selection dropdown when creating global schema

4. **Edit Mode Implementation**
   - Transform SchemaManagementCard from view mode to edit mode
   - Save/Cancel buttons with appropriate loading states
   - Confirm dialog for unsaved changes when canceling
   - Visual indication of edit mode (different styling/borders)

5. **Basic Schema Editing Fields**
   - Schema name editing with validation (same rules as creation)
   - Description editing with multiline text support
   - Real-time character count for description field
   - Form state management with React Hook Form

6. **Save and Cancel Functionality**
   - Save changes via API with optimistic updates
   - Handle concurrent editing conflicts gracefully
   - Success feedback with updated schema information
   - Automatic return to view mode after successful save
   - Revert all changes to original values on cancel

7. **Default Schema Management**
   - Checkbox or toggle button for "Set as Default Schema"
   - Clear visual indication of current default status
   - Ensure only one default schema per project at any time
   - Confirmation dialog when changing default schema

8. **Error Handling and Recovery**
   - Handle API errors during schema creation with user-friendly messages
   - Network error recovery with retry options
   - Validation error display with specific field guidance
   - Success feedback with option to immediately edit schema

## Tasks / Subtasks

- [ ] **Schema Creation Dialog Development** (AC: 1, 2, 3, 8)
  - [ ] Create `src/components/schema-management/SchemaCreateDialog.tsx` component
  - [ ] Implement modal dialog using Material-UI Dialog component
  - [ ] Add form fields with React Hook Form integration
  - [ ] Implement real-time validation with field-level error display
  - [ ] Add project context handling and selection logic

- [ ] **Schema Editing Implementation** (AC: 4, 5, 6)
  - [ ] Enhance `src/components/schema-management/SchemaManagementCard.tsx` for edit mode
  - [ ] Implement edit/view mode toggle with visual state indicators
  - [ ] Add React Hook Form integration for schema editing
  - [ ] Implement save/cancel functionality with confirmation dialogs
  - [ ] Add optimistic updates with error rollback

- [ ] **Default Schema Management** (AC: 7)
  - [ ] Create `src/components/schema-management/DefaultSchemaToggle.tsx` component
  - [ ] Implement default schema toggle with business logic validation
  - [ ] Add confirmation dialog for default schema changes
  - [ ] Ensure only one default per project constraint

- [ ] **Form State and Validation** (AC: 2, 5, 8)
  - [ ] Create `src/hooks/schema/useSchemaValidation.ts` hook
  - [ ] Create `src/hooks/schema/useSchemaForm.ts` hook
  - [ ] Create `src/hooks/schema/useDefaultSchemaToggle.ts` hook
  - [ ] Implement comprehensive form validation with Yup schema
  - [ ] Add debounced validation for real-time feedback

- [ ] **API Integration and Error Handling** (AC: 6, 8)
  - [ ] Extend schema management service with CRUD operations
  - [ ] Implement React Query mutations for create/update operations
  - [ ] Add comprehensive error handling with user-friendly messages
  - [ ] Implement optimistic updates with proper rollback logic

## Dev Notes

### Architecture Context
**Source:** [docs/architecture.md] - React Hook Form ^7.45.0 for form state management with optimistic updates and conflict resolution. Component-based architecture with sophisticated editing modals.

**Form Patterns:** [docs/architecture.md#architectural-patterns] - Multi-stage validation with business rules and data integrity checks ensuring data quality with immediate user feedback.

### Form State Management
**Source:** [docs/architecture.md#tech-stack] - State Management: React Query + React Hook Form for server state + form state management with optimistic updates.

**Validation Strategy:** Real-time validation with debounced API calls, client-side validation with Yup schemas, and server-side validation integration.

### Modal Implementation Patterns
**Source:** [docs/front-end-spec.md] - Leverage established patterns with engineering-specific enhancements. Modal dialogs should follow Material-UI design system patterns.

**Material-UI Components:**
- Dialog, DialogTitle, DialogContent, DialogActions for modal structure
- TextField, FormControl, FormHelperText for form fields
- Button, LoadingButton for actions with loading states

### Component Integration
**Source:** Story 3.2 - Schema creation must integrate with SchemaManagementCard component from previous story and SchemaListView for triggering creation dialog.

**Integration Points:**
- SchemaListView: "Create Schema" button trigger
- SchemaManagementCard: Edit mode toggle and inline editing
- Navigation: Context-aware creation (project vs global)

### API Integration Requirements
**Expected API Endpoints:**
- `createSchema(schemaData)` - Create new schema with validation
- `updateSchema(schemaId, updates)` - Update existing schema
- `setDefaultSchema(projectId, schemaId)` - Set default schema for project
- `validateSchemaName(projectId, name)` - Real-time name validation

### Business Logic Constraints
**Default Schema Rules:**
- Only one default schema per project allowed
- Changing default must unset previous default automatically
- Default schema cannot be deleted without setting new default
- Global schemas cannot be set as project defaults

### State Management Patterns
**Optimistic Updates:** Update UI immediately, rollback on API failure with clear error messaging
**Conflict Resolution:** Handle concurrent edits with last-write-wins or user choice resolution
**Cache Management:** Invalidate related queries on successful mutations

### Testing

**Testing Standards:** [docs/architecture.md#tech-stack] - Jest + React Testing Library for component testing with accessible component queries.

**Testing Requirements for this Story:**
- Form validation testing with valid/invalid inputs
- Modal dialog behavior testing (open/close/cancel)
- Optimistic update and rollback testing
- Default schema business logic testing
- API error handling testing
- Accessibility testing for form elements and modals

**Test File Locations:**
- `src/components/schema-management/SchemaCreateDialog.test.tsx`
- `src/components/schema-management/DefaultSchemaToggle.test.tsx`
- `src/hooks/schema/useSchemaForm.test.ts`
- `src/hooks/schema/useDefaultSchemaToggle.test.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-26 | 1.0 | Initial story creation with template compliance | Scrum Master |
| 2025-01-26 | 1.1 | Story validation completed, status updated to Approved | Product Owner |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
*To be populated by dev agent during implementation*

### Completion Notes List
*To be populated by dev agent during implementation*

### File List
*To be populated by dev agent during implementation*

## QA Results
*To be populated by QA agent after implementation review*