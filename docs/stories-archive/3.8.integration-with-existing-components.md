# Story 3.8: Integration with Existing Components

## Status
Draft

## Story
**As a** railroad bridge engineer,
**I want** schema management to work seamlessly with my existing component creation workflow,
**so that** I can easily manage schemas and use them naturally when creating components.

## Acceptance Criteria

1. **FlexibleComponentCard Integration**
   - Automatic schema selection updates when default schema changes
   - Schema dropdown updates immediately when new schemas are created
   - Cache invalidation ensures fresh schema list in component forms
   - "Manage Schemas" link accessible from component creation interface

2. **Quick Schema Access from Component Context**
   - "Edit Schema" option directly from component creation forms
   - Modal or side panel for quick schema modifications
   - Context-aware navigation that returns user to component creation
   - Preserve component creation state when navigating to schema management

3. **Schema Change Notifications**
   - Real-time updates to schema-dependent interfaces when schemas change
   - Component creation forms reflect latest schema configurations
   - Event system for schema change propagation across components
   - Graceful handling of schema changes during component editing

4. **Navigation Integration**
   - Breadcrumb navigation: Dashboard → Projects → [Project] → Schemas → [Schema]
   - Context-aware back navigation preserving user's journey
   - Deep linking support for direct schema editing access
   - Navigation state preservation during cross-page operations

5. **Component-Schema Workflow Integration**
   - "Create Component with This Schema" action after schema creation
   - Pre-populate component form with schema's default values
   - Guided workflow from schema creation to first component
   - Seamless transition with proper context preservation

6. **Schema Usage Reporting**
   - Real-time count of components using each schema
   - "View Components" link from schema management to filtered component list
   - Usage analytics for schema optimization decisions
   - Historical usage tracking for schema evolution

7. **Cross-Component Communication**
   - Schema selection triggers automatic form restructuring in component creation
   - Dynamic form generation based on selected schema
   - Consistent error handling across schema and component interfaces
   - Real-time sync between schema management and component creation

8. **Component Migration Support**
   - Tools for migrating components between schemas
   - Data mapping interface for schema field changes
   - Migration preview with impact analysis before execution
   - Rollback capability if component updates fail

## Tasks / Subtasks

- [ ] **FlexibleComponentCard Enhancement** (AC: 1, 2, 7)
  - [ ] Enhance `src/components/flexible/FlexibleComponentCard.tsx` with schema management integration
  - [ ] Add schema management access buttons and navigation
  - [ ] Implement real-time schema selection updates
  - [ ] Add quick schema editing modal/panel functionality
  - [ ] Integrate with schema change notification system

- [ ] **Navigation System Integration** (AC: 4)
  - [ ] Enhance `src/components/Navigation.tsx` with schema management menu items
  - [ ] Create `src/hooks/schema/useSchemaNavigation.ts` hook
  - [ ] Implement context-aware navigation with state preservation
  - [ ] Add breadcrumb navigation for schema management flows
  - [ ] Implement deep linking support for schema editing

- [ ] **Cross-Component Event System** (AC: 3, 7)
  - [ ] Create `src/utils/schemaEventBus.ts` event system
  - [ ] Create `src/hooks/schema/useSchemaChangeListener.ts` hook
  - [ ] Implement schema change event propagation
  - [ ] Add real-time sync between schema and component interfaces
  - [ ] Implement graceful error handling for sync failures

- [ ] **Workflow Integration Components** (AC: 5, 6)
  - [ ] Create `src/components/schema-management/CreateComponentButton.tsx` component
  - [ ] Create `src/components/schema-management/SchemaUsageStats.tsx` component
  - [ ] Implement guided workflow from schema to component creation
  - [ ] Add schema usage reporting and analytics
  - [ ] Implement component list integration with schema filtering

- [ ] **Component Migration Tools** (AC: 8)
  - [ ] Create `src/components/schema-management/ComponentMigrationTool.tsx` component
  - [ ] Create `src/services/componentMigrationService.ts` service
  - [ ] Implement data mapping interface for field changes
  - [ ] Add migration preview and impact analysis
  - [ ] Implement rollback capability for failed migrations

## Dev Notes

### Architecture Context
**Source:** [docs/architecture.md] - Component-based architecture with sophisticated editing modals and real-time validation. Integration must maintain existing patterns.

**Dependency:** This story integrates with all previous schema management stories (3.1-3.7) and existing component creation workflows.

### FlexibleComponentCard Integration
**Source:** Current project structure analysis - `src/components/flexible/FlexibleComponentCard.tsx` is the main component creation interface.

**Integration Points:**
- Schema selection dropdown integration
- Quick access to schema management
- Real-time schema updates
- Context preservation during navigation

**Integration Strategy:**
```typescript
// Enhanced FlexibleComponentCard with schema management
interface FlexibleComponentCardProps {
  component?: Component;
  projectId: string;
  onComponentChange: (component: Component) => void;
  onSchemaManagementAccess?: () => void;
}
```

### Navigation Integration Requirements
**Source:** `src/components/Navigation.tsx` - Existing navigation structure needs schema management integration.

**Navigation Enhancements:**
- Add "Schema Management" menu item
- Project-context schema access
- Breadcrumb integration
- Active route highlighting

### Cross-Component Communication Architecture
**Event System Design:**
```typescript
interface SchemaChangeEvent {
  type: 'schema-updated' | 'schema-deleted' | 'default-changed';
  schemaId: string;
  projectId: string;
  data?: any;
}
```

**Event Propagation:**
- Schema management triggers events
- Component creation listens for events
- Automatic UI updates on schema changes
- Error recovery for failed updates

### Component Migration System
**Migration Types:**
- Schema field addition/removal
- Field type changes with data conversion
- Field name changes with mapping
- Schema replacement for components

**Migration Safety:**
- Preview mode showing impact before execution
- Backup creation before migration
- Rollback capability for failed operations
- Validation of data compatibility

### API Integration Requirements
**Expected API Endpoints:**
- `getSchemaUsage(schemaId)` - Get components using schema
- `migrateComponents(fromSchema, toSchema, mapping)` - Migrate components
- `validateMigration(components, newSchema)` - Validate migration feasibility
- `getSchemaChangeImpact(schemaId, changes)` - Analyze change impact

### State Management Integration
**Source:** Story 3.7 - State management optimization provides foundation for cross-component state synchronization.

**Integration Requirements:**
- Schema editing context integration
- Component creation state preservation
- Event-driven state updates
- Conflict resolution between interfaces

### URL Structure and Routing
**Schema Management Routes:**
- `/schemas` - Global schema management
- `/projects/:projectId/schemas` - Project schema management
- `/projects/:projectId/schemas/:schemaId/edit` - Schema editing
- `/projects/:projectId/schemas/:schemaId/components` - Schema usage view

### Session Storage for Context Preservation
**Context Data Storage:**
```typescript
interface ComponentEditingContext {
  componentId?: string;
  projectId: string;
  returnTo: 'component-creation' | 'component-list';
  formData?: any;
  selectedSchema?: string;
}
```

### Performance Considerations
**Integration Performance:**
- Efficient event propagation without excessive re-renders
- Lazy loading of schema management components
- Optimal caching strategy for cross-component data
- Minimal impact on existing component creation performance

### Testing

**Testing Standards:** [docs/architecture.md#tech-stack] - Jest + React Testing Library with emphasis on integration testing and cross-component interactions.

**Testing Requirements for this Story:**
- FlexibleComponentCard integration testing
- Navigation integration testing with route changes
- Cross-component event system testing
- Component migration testing with various scenarios
- Context preservation testing during navigation
- Real-time update testing between schema and component interfaces

**Test File Locations:**
- `src/components/flexible/FlexibleComponentCard.test.tsx` (enhanced)
- `src/hooks/schema/useSchemaNavigation.test.ts`
- `src/utils/schemaEventBus.test.ts`
- `src/components/schema-management/ComponentMigrationTool.test.tsx`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-26 | 1.0 | Initial story creation with template compliance | Scrum Master |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent during implementation*

### Debug Log References
*To be populated by dev agent during implementation*

### Completion Notes List
*To be populated by dev agent during implementation*

### File List
*To be populated by dev agent during implementation*

## QA Results
*To be populated by QA agent after implementation review*