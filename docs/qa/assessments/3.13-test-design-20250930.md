# Test Design: Story 3.13 - schema-refactoring

**Date:** 2025-09-30
**Designer:** Quinn (Test Architect)
**Story:** 3.13 - Schema System Refactoring
**Status:** Approved

---

## Test Strategy Overview

**Total Test Scenarios:** 58
**Distribution:**
- **Unit tests:** 18 (31%)
- **Integration tests:** 28 (48%)
- **E2E tests:** 12 (21%)

**Priority Distribution:**
- **P0:** 24 scenarios (critical - data integrity, validation, security)
- **P1:** 22 scenarios (core user journeys)
- **P2:** 10 scenarios (secondary features)
- **P3:** 2 scenarios (nice-to-have)

**Coverage:** 40/40 acceptance criteria covered (100%)

---

## Test Philosophy

This test strategy follows **shift-left principles** with emphasis on:

1. **Risk-based prioritization** - P0 tests focus on data integrity and user-blocking issues
2. **Efficient coverage** - Test once at the appropriate level (avoid redundancy)
3. **Phase alignment** - Tests organized by implementation phases for incremental validation
4. **Maintainability** - Integration tests preferred over E2E where sufficient
5. **Fast feedback** - Unit tests provide immediate validation of pure logic

---

## Test Scenarios by Functional Requirement

### FR-1: Schema Naming Validation & User Feedback (AC 1-5)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-001 | Unit | P0 | Validate regex pattern `[a-zA-Z0-9_-]` accepts valid characters | Pure validation logic, fast feedback |
| 3.13-UNIT-002 | Unit | P0 | Validate regex rejects invalid characters (space, !, @, etc.) | Pure validation logic, critical for data integrity |
| 3.13-UNIT-003 | Unit | P0 | Validate min length (3 chars) enforcement | Boundary condition testing |
| 3.13-UNIT-004 | Unit | P0 | Validate max length (100 chars) enforcement | Boundary condition testing |
| 3.13-UNIT-005 | Unit | P0 | Validate leading/trailing space rejection | Edge case, data cleanliness |
| 3.13-UNIT-006 | Unit | P0 | Validate must start with letter/number rule | Business rule validation |
| 3.13-INT-001 | Integration | P0 | Backend validation service returns correct error messages | Error messaging flows through API |
| 3.13-INT-002 | Integration | P0 | Case-insensitive uniqueness check (DB query) | Database interaction required |
| 3.13-INT-003 | Integration | P1 | Frontend real-time validation triggers on keypress | Frontend-backend integration |
| 3.13-E2E-001 | E2E | P1 | User enters invalid name → sees error → corrects → save succeeds | Critical user journey, AC compliance |

**AC Coverage:** ACs 1-5 ✅

---

### FR-2: Post-Creation Navigation & Success Confirmation (AC 6-10)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-004 | Integration | P0 | API returns schema ID on successful creation | Backend contract validation |
| 3.13-INT-005 | Integration | P1 | Frontend redirects to `/schemas?project=[id]&highlight=[schema-id]` | Navigation logic with query params |
| 3.13-INT-006 | Integration | P1 | Success toast notification displays with schema name | UI feedback mechanism |
| 3.13-INT-007 | Integration | P1 | Newly created schema appears in list and is highlighted | State refresh + UI highlighting |
| 3.13-INT-008 | Integration | P2 | Navigation failure keeps user on form with success message | Error handling edge case |
| 3.13-E2E-002 | E2E | P1 | User creates schema → redirected to list → schema highlighted | Complete creation journey |

**AC Coverage:** ACs 6-10 ✅

---

### FR-3: Field Addition Save State Management (AC 11-16)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-007 | Unit | P0 | Dirty state detection: initial snapshot vs current state comparison | Pure state comparison logic |
| 3.13-UNIT-008 | Unit | P0 | isDirty flag set to true when field added | State flag logic |
| 3.13-UNIT-009 | Unit | P0 | isDirty flag set to true when field edited | State flag logic |
| 3.13-UNIT-010 | Unit | P0 | isDirty flag set to true when field removed | State flag logic |
| 3.13-UNIT-011 | Unit | P0 | isDirty flag set to true when fields reordered | State flag logic |
| 3.13-UNIT-012 | Unit | P0 | isDirty flag remains false when no changes | Negative case validation |
| 3.13-INT-009 | Integration | P1 | Save button enables when isDirty = true (React Hook Form) | Form state management integration |
| 3.13-INT-010 | Integration | P1 | Unsaved changes warning triggered on navigation attempt | Browser navigation event handling |
| 3.13-E2E-003 | E2E | P1 | User adds field → save button enables → saves → field persists on reload | Complete field addition workflow |

**AC Coverage:** ACs 11-16 ✅

---

### FR-4: Schema Name Update Persistence (AC 17-21)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-011 | Integration | P0 | PATCH /api/schemas/{id} accepts name update | API endpoint contract |
| 3.13-INT-012 | Integration | P0 | Name uniqueness validation excludes current schema during update | Database query logic |
| 3.13-INT-013 | Integration | P0 | Updated schema object returned in API response | API response validation |
| 3.13-INT-014 | Integration | P0 | Audit trail logs name change with user + timestamp | Audit logging requirement |
| 3.13-INT-015 | Integration | P1 | Schema list updates immediately after name change (React Query invalidation) | Cache invalidation logic |
| 3.13-E2E-004 | E2E | P1 | User renames schema → saves → name appears in list → reload shows updated name | Complete rename workflow |

**AC Coverage:** ACs 17-21 ✅

---

### FR-5: Multi-Select Field Type Implementation (AC 22-27)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-016 | Integration | P1 | Schema editor creates multi-select field with options configuration | Known bug fix - integration level |
| 3.13-INT-017 | Integration | P1 | Multi-select field config saves to database with JSON structure | Database persistence of JSON field |
| 3.13-INT-018 | Integration | P1 | Component form renders multi-select field (UI component) | Component rendering with schema data |
| 3.13-INT-019 | Integration | P1 | Multiple values can be selected from options list | Multi-value selection logic |
| 3.13-INT-020 | Integration | P1 | Selected values persist to `component.dynamic_data` as array | Data persistence validation |
| 3.13-INT-021 | Integration | P2 | Multi-select displays correctly in read-only mode | Display logic validation |
| 3.13-E2E-005 | E2E | P1 | User creates multi-select field → configures options → component uses field → values save | Complete multi-select workflow |

**AC Coverage:** ACs 22-27 ✅

---

### FR-6: Default Schema Protection (AC 28-33)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-013 | Unit | P0 | `is_system_default` flag check logic | Simple boolean check logic |
| 3.13-INT-022 | Integration | P0 | Backend rejects PATCH on default schema with 403 Forbidden | Security endpoint validation |
| 3.13-INT-023 | Integration | P0 | Backend rejects DELETE on default schema with 403 Forbidden | Security endpoint validation |
| 3.13-INT-024 | Integration | P0 | Error message: "Cannot modify system default schema" | Error messaging validation |
| 3.13-INT-025 | Integration | P1 | Frontend disables/hides Edit button for default schema | UI state based on schema flag |
| 3.13-INT-026 | Integration | P1 | Frontend disables/hides Delete button for default schema | UI state based on schema flag |
| 3.13-INT-027 | Integration | P1 | "System Default" badge displays in UI | Visual indicator rendering |
| 3.13-INT-028 | Integration | P2 | Duplicate functionality creates editable copy of default schema | Copy operation with flag reset |
| 3.13-E2E-006 | E2E | P1 | User attempts to edit default schema → buttons disabled → tooltip explains why | Protection mechanism validation |

**AC Coverage:** ACs 28-33 ✅

---

### FR-7: Schema Deletion with Dependency Validation (AC 34-40)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-014 | Unit | P0 | Dependency count query logic (components using schema) | Database query logic |
| 3.13-INT-029 | Integration | P0 | GET /api/schemas/{id}/usage returns component count | New API endpoint validation |
| 3.13-INT-030 | Integration | P0 | Soft delete sets `is_active = false` instead of hard delete | Data preservation requirement |
| 3.13-INT-031 | Integration | P0 | Soft-deleted schemas removed from list views | Query filter validation |
| 3.13-INT-032 | Integration | P0 | Audit trail preserved after soft delete | Audit requirement validation |
| 3.13-INT-033 | Integration | P1 | Warning dialog shows component count when schema in use | UI logic with API data |
| 3.13-INT-034 | Integration | P1 | Reassignment updates all component `schema_id` references | Bulk update operation |
| 3.13-INT-035 | Integration | P1 | Confirmation dialog shows for unused schema deletion | UI logic for deletion |
| 3.13-INT-036 | Integration | P1 | Success message displayed after deletion | UI feedback |
| 3.13-E2E-007 | E2E | P1 | User deletes unused schema → confirmation → schema removed from list | Standard deletion flow |
| 3.13-E2E-008 | E2E | P1 | User attempts to delete in-use schema → warning → reassigns → then deletes | Complex reassignment workflow |
| 3.13-E2E-009 | E2E | P2 | Default schema cannot be deleted (combines FR-6 + FR-7) | Cross-feature validation |

**AC Coverage:** ACs 34-40 ✅

---

## Additional Test Coverage

### Comprehensive Field Type Testing (Dev Notes Requirement)

All 8 field types must be tested for: create, edit, save, render, data persistence, multiple instances.

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-037 | Integration | P1 | Text field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-038 | Integration | P1 | Textarea field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-039 | Integration | P1 | Number field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-040 | Integration | P1 | Date field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-041 | Integration | P1 | Select field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-042 | Integration | P1 | Checkbox field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-043 | Integration | P1 | Autocomplete field: create, edit, save, render, persist | Core field type validation |
| 3.13-INT-044 | Integration | P2 | Multiple fields of same type in single schema | Edge case validation |

**Note:** Multi-select covered in FR-5 scenarios.

---

### Regression Testing

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-045 | Integration | P0 | Component editor still functions with updated schema API | Prevent breaking existing features |
| 3.13-E2E-010 | E2E | P1 | Existing components using schemas display correctly | Backward compatibility |

---

### Performance Testing

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-015 | Unit | P1 | Validation response time <300ms | NFR requirement validation |
| 3.13-INT-046 | Integration | P1 | Schema list load time <2s (99th percentile, up to 50 schemas) | NFR requirement validation |
| 3.13-INT-047 | Integration | P1 | Schema save operation completes <3s | NFR requirement validation |

---

### Special Test Cases

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-INT-048 | Integration | P2 | Special project IDs: default-project, demo-project, unassigned, global | Known edge cases from recent work |
| 3.13-E2E-011 | E2E | P3 | Concurrent editing detection (if not descoped) | Nice-to-have, may be Phase 4 |
| 3.13-UNIT-016 | Unit | P2 | Pagination logic for >50 schemas (20 per page) | NFR requirement |

---

### Security Testing

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.13-UNIT-017 | Unit | P0 | Input sanitization prevents XSS in schema names | Security requirement |
| 3.13-UNIT-018 | Unit | P0 | SQL injection protection via parameterized queries | Security requirement |
| 3.13-E2E-012 | E2E | P2 | User can only modify schemas in permitted projects | Authorization validation |

---

## Risk Coverage Matrix

| Risk ID | Description | Mitigating Tests | Priority |
|---------|-------------|------------------|----------|
| RISK-001 | Silent validation failures block users | 3.13-UNIT-001 through 3.13-UNIT-006, 3.13-E2E-001 | P0 |
| RISK-002 | Broken navigation leaves users with blank screens | 3.13-INT-004 through 3.13-INT-008, 3.13-E2E-002 | P0 |
| RISK-003 | Save state failures prevent field modifications | 3.13-UNIT-007 through 3.13-UNIT-012, 3.13-E2E-003 | P0 |
| RISK-004 | Schema name updates fail to persist | 3.13-INT-011 through 3.13-INT-015, 3.13-E2E-004 | P0 |
| RISK-005 | Multi-select field type non-functional | 3.13-INT-016 through 3.13-INT-021, 3.13-E2E-005 | P1 |
| RISK-006 | Default schema corruption risk | 3.13-UNIT-013, 3.13-INT-022 through 3.13-INT-028, 3.13-E2E-006 | P0 |
| RISK-007 | Data loss from unsafe deletions | 3.13-UNIT-014, 3.13-INT-029 through 3.13-INT-036, 3.13-E2E-007, 3.13-E2E-008 | P0 |
| RISK-008 | Regression in existing component functionality | 3.13-INT-045, 3.13-E2E-010 | P0 |
| RISK-009 | Performance degradation | 3.13-UNIT-015, 3.13-INT-046, 3.13-INT-047 | P1 |
| RISK-010 | Security vulnerabilities (XSS, injection) | 3.13-UNIT-017, 3.13-UNIT-018 | P0 |

---

## Test Execution Strategy

### Phase 1: Critical User Blockers (Week 1)

**Focus:** FR-1, FR-2, FR-4

**Execution Order:**
1. **P0 Unit Tests** (fail fast)
   - 3.13-UNIT-001 through 3.13-UNIT-006 (validation logic)
2. **P0 Integration Tests**
   - 3.13-INT-001, 3.13-INT-002 (validation API)
   - 3.13-INT-004 (schema creation API)
   - 3.13-INT-011 through 3.13-INT-014 (name update)
3. **P1 Integration Tests**
   - 3.13-INT-003 (real-time validation)
   - 3.13-INT-005 through 3.13-INT-008 (navigation)
   - 3.13-INT-015 (cache invalidation)
4. **P1 E2E Tests**
   - 3.13-E2E-001 (validation journey)
   - 3.13-E2E-002 (creation journey)
   - 3.13-E2E-004 (rename journey)

**Expected Test Count:** ~20 tests

---

### Phase 2: State Management & Field Issues (Week 2)

**Focus:** FR-3, FR-5, Comprehensive Field Testing

**Execution Order:**
1. **P0 Unit Tests**
   - 3.13-UNIT-007 through 3.13-UNIT-012 (dirty state detection)
2. **P1 Integration Tests**
   - 3.13-INT-009, 3.13-INT-010 (form state)
   - 3.13-INT-016 through 3.13-INT-021 (multi-select)
   - 3.13-INT-037 through 3.13-INT-043 (all field types)
3. **P2 Integration Tests**
   - 3.13-INT-044 (multiple fields of same type)
4. **P1 E2E Tests**
   - 3.13-E2E-003 (field addition journey)
   - 3.13-E2E-005 (multi-select journey)

**Expected Test Count:** ~25 tests

---

### Phase 3: Safety & Protection (Week 3)

**Focus:** FR-6, FR-7, Security, Regression

**Execution Order:**
1. **P0 Unit Tests**
   - 3.13-UNIT-013 (default schema flag)
   - 3.13-UNIT-014 (dependency query)
   - 3.13-UNIT-017, 3.13-UNIT-018 (security)
2. **P0 Integration Tests**
   - 3.13-INT-022 through 3.13-INT-024 (default schema protection)
   - 3.13-INT-029 through 3.13-INT-032 (deletion with dependencies)
   - 3.13-INT-045 (regression - component editor)
3. **P1 Integration Tests**
   - 3.13-INT-025 through 3.13-INT-028 (default schema UI)
   - 3.13-INT-033 through 3.13-INT-036 (deletion UI)
   - 3.13-INT-046, 3.13-INT-047 (performance)
4. **P1 E2E Tests**
   - 3.13-E2E-006 (default schema protection journey)
   - 3.13-E2E-007, 3.13-E2E-008 (deletion journeys)
   - 3.13-E2E-010 (regression - existing components)
5. **P2 Tests**
   - 3.13-E2E-009 (cross-feature deletion)
   - 3.13-INT-048 (special project IDs)
   - 3.13-E2E-012 (authorization)

**Expected Test Count:** ~23 tests

---

## Test Automation Recommendations

### Unit Tests (18 scenarios)
- **Framework:** pytest (backend), Jest (frontend)
- **Location:** `/backend/tests/test_schema_service.py`, `/backend/tests/test_validation.py`
- **Execution:** `pytest -v` (~2-3 minutes)
- **Coverage Target:** >80% for validation and state management logic

### Integration Tests (28 scenarios)
- **Framework:** pytest + TestClient (backend), React Testing Library (frontend)
- **Location:** `/backend/tests/test_schemas_api.py`, `/frontend/src/components/schema/__tests__/`
- **Execution:** `pytest tests/test_schemas_api.py -v` + `npm test` (~5-8 minutes)
- **Database:** Use isolated test database (SQLAlchemy fixtures)

### E2E Tests (12 scenarios)
- **Framework:** Playwright
- **Execution:** `npx playwright test` (~8-12 minutes)
- **Test Data:** Fresh database with default schema + sample components

---

## Coverage Validation

### Acceptance Criteria Coverage

✅ **100% AC Coverage** - All 40 acceptance criteria have dedicated test scenarios

| FR | AC Count | Unit Tests | Integration Tests | E2E Tests | Total Tests |
|----|----------|------------|-------------------|-----------|-------------|
| FR-1 | 5 | 6 | 3 | 1 | 10 |
| FR-2 | 5 | 0 | 5 | 1 | 6 |
| FR-3 | 6 | 6 | 2 | 1 | 9 |
| FR-4 | 5 | 0 | 5 | 1 | 6 |
| FR-5 | 6 | 0 | 6 | 1 | 7 |
| FR-6 | 6 | 1 | 7 | 1 | 9 |
| FR-7 | 7 | 1 | 8 | 3 | 12 |

**Additional Coverage:**
- Field type testing: 8 scenarios
- Regression: 2 scenarios
- Performance: 3 scenarios
- Special cases: 2 scenarios
- Security: 3 scenarios

---

## Test Maintenance Considerations

### Fast Feedback Loop
- **Unit tests run first** (~3 min) - catch logic errors immediately
- **Integration tests second** (~8 min) - validate API contracts and component interactions
- **E2E tests last** (~12 min) - confirm critical user journeys

### Test Independence
- All tests are atomic and independent (no execution order dependencies)
- Each test sets up its own data fixtures
- Database isolation via transaction rollback or test database cleanup

### Maintainability
- Test IDs follow consistent naming: `{epic}.{story}-{LEVEL}-{SEQ}`
- Clear descriptions avoid future confusion
- Justification explains why each test level was chosen
- Scenarios map directly to acceptance criteria for traceability

---

## Quality Gate YAML Block

```yaml
test_design:
  date: 2025-09-30
  designer: Quinn
  scenarios_total: 58
  by_level:
    unit: 18
    integration: 28
    e2e: 12
  by_priority:
    p0: 24
    p1: 22
    p2: 10
    p3: 2
  coverage:
    acceptance_criteria: 40/40 (100%)
    coverage_gaps: []
    risk_coverage: 10/10 risks mitigated
  execution_estimates:
    phase_1_tests: 20
    phase_2_tests: 25
    phase_3_tests: 23
    total_runtime_estimate: "23-30 minutes"
  recommendations:
    - Prioritize P0 unit tests for fastest failure detection
    - Time-box multi-select investigation to 4 hours before Phase 2 testing
    - Run regression tests (INT-045, E2E-010) before Phase 3 sign-off
    - Validate performance benchmarks (UNIT-015, INT-046, INT-047) with realistic data
```

---

## Test Design Sign-Off

**Designed By:** Quinn (Test Architect)
**Date:** 2025-09-30
**Story Status:** Approved
**Test Design Status:** ✅ **READY FOR IMPLEMENTATION**

**Validation Checklist:**
- [x] Every AC has test coverage
- [x] Test levels are appropriate (shift-left applied)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk coverage matrix complete
- [x] Execution strategy by phase defined

---

**Next Steps:**
1. Review test design with development team
2. Confirm multi-select investigation time-box (4 hours) before Phase 2
3. Set up test data fixtures for E2E tests
4. Begin Phase 1 test implementation alongside feature development

---

*Test design document generated by Quinn (Test Architect) using BMAD™ Core test-design workflow*
