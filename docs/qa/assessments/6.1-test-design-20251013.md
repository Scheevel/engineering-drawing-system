# Test Design: Story 6.1 - Dimension & Specification Management UI

**Date**: 2025-10-13
**Designer**: Quinn (Test Architect)
**Story ID**: 6.1
**Epic**: Component Data Management

---

## Executive Summary

### Test Strategy Overview

- **Total test scenarios**: 47
- **Unit tests**: 22 (47%)
- **Integration tests**: 18 (38%)
- **E2E tests**: 7 (15%)
- **Priority distribution**: P0: 21, P1: 19, P2: 7

### Risk Profile

This story has **MODERATE RISK** due to:
- ✅ **LOW** frontend complexity (following existing patterns)
- ⚠️ **MODERATE** backend coordination (schema migration required)
- ✅ **LOW** data risk (only 9 dimensions in database, pre-verified compatibility)
- ⚠️ **MODERATE** fractional input parsing complexity (new algorithm)

### Test Coverage Approach

**Shift-Left Strategy**: Emphasize unit testing for fractional parser (complex algorithm) and integration testing for API contracts (backend coordination critical).

**Defense-in-Depth**: P0 scenarios tested at multiple levels where backend-frontend coordination is critical (display_format preservation).

---

## Test Scenarios by Acceptance Criteria

### AC1: Dimension Management Dialogs

#### AC1.1: Add Dimension Dialog

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-001 | Unit | P0 | Parse pure decimal input "15.75" → 15.75 | Core parser logic, complex algorithm with GCD |
| 6.1-UNIT-002 | Unit | P0 | Parse mixed fraction "15 3/4" → 15.75 | Core parser logic, space-separated format |
| 6.1-UNIT-003 | Unit | P0 | Parse hyphenated fraction "15-3/4" → 15.75 | Core parser logic, alternative format |
| 6.1-UNIT-004 | Unit | P0 | Parse pure fraction "3/4" → 0.75 | Core parser logic, fractional only |
| 6.1-UNIT-005 | Unit | P0 | Reject zero denominator "15/0" with error | Critical edge case, data integrity |
| 6.1-UNIT-006 | Unit | P1 | Detect display format from "/" presence | Pure logic, format detection algorithm |
| 6.1-UNIT-007 | Unit | P1 | Validate improper fractions "5/3" → 1.667 accepted | Edge case handling |
| 6.1-UNIT-008 | Unit | P2 | Reject complex fractions "15 3/4 5/8" | Edge case rejection |
| 6.1-INT-001 | Integration | P0 | Create dimension with fraction format via API | Backend-frontend contract validation |
| 6.1-INT-002 | Integration | P0 | Verify display_format='fraction' stored correctly | Database persistence verification |
| 6.1-INT-003 | Integration | P1 | Create dimension with decimal format via API | Backend-frontend contract validation |
| 6.1-INT-004 | Integration | P1 | Verify display_format='decimal' stored correctly | Database persistence verification |
| 6.1-INT-005 | Integration | P1 | Backend validation rejects invalid display_format | Pydantic validation enforcement |
| 6.1-E2E-001 | E2E | P0 | User adds dimension "15 3/4 in", sees success toast, dimension appears in table | Critical user journey |
| 6.1-E2E-002 | E2E | P1 | User adds dimension with decimal, reloads page, sees decimal format preserved | WYSIWYG verification |

#### AC1.2: Edit Dimension Dialog

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-INT-006 | Integration | P0 | Edit dimension updates display_format field | Partial update pattern validation |
| 6.1-INT-007 | Integration | P1 | Edit non-existent dimension returns 404 | Error handling validation |
| 6.1-INT-008 | Integration | P1 | Edit dimension with missing display_format defaults correctly | Backward compatibility |
| 6.1-E2E-003 | E2E | P0 | User edits dimension value "15 3/4" → "16 1/2", sees updated value | Critical edit workflow |
| 6.1-E2E-004 | E2E | P1 | User edits dimension, receives 404, sees "already deleted" message | Error path UX validation |

#### AC1.3: Delete Dimension Confirmation

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-INT-009 | Integration | P0 | Delete dimension via API removes from database | Data integrity verification |
| 6.1-INT-010 | Integration | P1 | Delete non-existent dimension returns 404 | Error handling validation |
| 6.1-E2E-005 | E2E | P0 | User clicks delete, confirms, sees success toast, dimension removed from table | Critical delete workflow |

---

### AC2: Specification Management Dialogs

#### AC2.1-2.3: Specification CRUD Operations

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-INT-011 | Integration | P1 | Create specification via API | Similar to dimensions, lower priority |
| 6.1-INT-012 | Integration | P1 | Update specification via API | Partial update pattern validation |
| 6.1-INT-013 | Integration | P1 | Delete specification via API | Data integrity verification |
| 6.1-E2E-006 | E2E | P1 | User adds/edits/deletes specification successfully | Complete specification workflow |

**Rationale**: Specifications follow identical pattern to dimensions but WITHOUT fractional input complexity. Lower priority since dimensions are more complex and critical (engineering measurements vs. metadata).

---

### AC3: Database Schema Changes

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-INT-014 | Integration | P0 | Migration adds display_format column to dimensions | Schema change verification |
| 6.1-INT-015 | Integration | P0 | Migration adds display_format column to specifications | Schema change verification |
| 6.1-INT-016 | Integration | P0 | Migration rollback removes display_format columns | Rollback safety verification |
| 6.1-INT-017 | Integration | P0 | Existing dimensions retain data after migration | Data loss prevention |
| 6.1-INT-018 | Integration | P1 | Default value 'decimal' applied to new records | Default value enforcement |

**Rationale**: Database migrations are P0 because they affect ALL environments and are hard to fix in production. Rollback capability is critical.

---

### AC4: API Contract Updates

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-009 | Unit | P0 | Pydantic validator rejects invalid display_format values | Input validation logic |
| 6.1-UNIT-010 | Unit | P1 | Pydantic validator accepts 'decimal' and 'fraction' | Positive validation |
| 6.1-INT-019 | Integration | P0 | POST endpoint accepts display_format field | API contract validation |
| 6.1-INT-020 | Integration | P0 | PUT endpoint accepts display_format field | API contract validation |
| 6.1-INT-021 | Integration | P0 | GET endpoint returns display_format field | API contract validation |
| 6.1-INT-022 | Integration | P1 | Missing display_format in request defaults to 'decimal' | Backward compatibility |
| 6.1-INT-023 | Integration | P1 | OpenAPI schema documents display_format field | API documentation verification |

---

### AC5: Display Format Logic (WYSIWYG Behavior)

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-011 | Unit | P0 | Detect fraction format when "/" present | Format detection logic |
| 6.1-UNIT-012 | Unit | P0 | Detect decimal format when no "/" present | Format detection logic |
| 6.1-INT-024 | Integration | P0 | Store fraction input → display_format='fraction' | Round-trip verification |
| 6.1-INT-025 | Integration | P0 | Store decimal input → display_format='decimal' | Round-trip verification |
| 6.1-INT-026 | Integration | P1 | Legacy data with NULL display_format shows smart defaults | Backward compatibility |
| 6.1-E2E-007 | E2E | P0 | User enters "15 3/4", reloads page, sees "15 3/4" (not "15.75") | WYSIWYG UX validation |

**Rationale**: Display format preservation is the CORE UX feature of this story - P0 priority to ensure "what you type is what you see" works correctly.

---

### AC6: Existing Functionality Preservation

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-INT-027 | Integration | P0 | Read/display of dimensions continues unchanged | Regression prevention |
| 6.1-INT-028 | Integration | P1 | React-query cache invalidation triggers refetch | Cache behavior validation |
| 6.1-INT-029 | Integration | P1 | OCR-extracted dimensions remain functional | Backward compatibility |
| 6.1-E2E-008 | E2E | P1 | Existing dimensions display correctly in table after migration | Visual regression prevention |

---

### AC7: Pattern Consistency

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-013 | Unit | P2 | Dialog follows FieldCreationDialog pattern | Code review validation |
| 6.1-UNIT-014 | Unit | P2 | Delete confirmation follows ConfirmDialog pattern | Code review validation |

**Rationale**: P2 because pattern consistency is important for maintainability but doesn't affect functionality. Can be validated through code review.

---

### AC8: Data Integrity

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-015 | Unit | P0 | Yup validation prevents negative dimensions | Data integrity protection |
| 6.1-UNIT-016 | Unit | P0 | Yup validation prevents zero values | Data integrity protection |
| 6.1-UNIT-017 | Unit | P0 | Yup validation enforces max 4 decimal places | Precision limit enforcement |
| 6.1-UNIT-018 | Unit | P1 | Yup validation rejects empty required fields | Form validation |
| 6.1-UNIT-019 | Unit | P1 | Tolerance regex validation accepts "±0.5" format | Format validation |
| 6.1-INT-030 | Integration | P0 | API error responses display user-friendly messages | Error UX validation |
| 6.1-INT-031 | Integration | P1 | Optimistic updates rollback on API failure | UI state consistency |

---

### AC9: Testing Coverage (Meta-Test Requirements)

**Note**: These are test requirements, not test scenarios themselves. They define the coverage goals for the implementation.

- ✅ P0 Unit tests: Fractional parser (7 tests)
- ✅ P0 Integration tests: Backend migration (5 tests), API contract (7 tests)
- ✅ P0 E2E tests: Critical user journeys (5 tests)
- ✅ P1 tests: Edge cases and error paths (19 tests)

---

### AC10: User Experience

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-020 | Unit | P1 | Help text displays decimal preview during input | UX feedback validation |
| 6.1-UNIT-021 | Unit | P1 | Error messages are clear and actionable | Error UX validation |
| 6.1-INT-032 | Integration | P1 | Success toast notifications appear after mutations | User feedback validation |
| 6.1-E2E-009 | E2E | P2 | Keyboard navigation (Tab, Enter, Escape) works | Accessibility validation |
| 6.1-E2E-010 | E2E | P2 | Dialogs are responsive on tablet devices | Mobile UX validation |

---

### AC11: Code Quality

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.1-UNIT-022 | Unit | P2 | TypeScript interfaces defined for all props | Code review validation |
| 6.1-INT-033 | Integration | P2 | Migration follows Alembic naming conventions | Code review validation |

**Rationale**: P2 because code quality is enforced through CI/CD and code review, not runtime testing.

---

## Edge Case Coverage Matrix

### Fractional Input Edge Cases (19 documented in story)

| Edge Case | Test ID | Level | Priority | Coverage |
|-----------|---------|-------|----------|----------|
| 1. Zero denominator "15/0" | 6.1-UNIT-005 | Unit | P0 | ✅ Covered |
| 2. Improper fractions "5/3" | 6.1-UNIT-007 | Unit | P1 | ✅ Covered |
| 3. Complex fractions "15 3/4 5/8" | 6.1-UNIT-008 | Unit | P2 | ✅ Covered |
| 4. Negative values "-15 3/4" | 6.1-UNIT-015 | Unit | P0 | ✅ Covered (validation) |
| 5. Decimal in fraction "15 3.5/4" | 6.1-UNIT-008 | Unit | P2 | ✅ Covered (rejection) |
| 6. Very small fractions "1/64" | 6.1-UNIT-004 | Unit | P0 | ✅ Covered (precision) |
| 7-19. Other edge cases | N/A | Manual | P3 | ⚠️ Document in test plan |

---

## Risk Coverage Analysis

### RISK-001: Fractional Input Parsing Errors
**Mitigated by**: 6.1-UNIT-001 through 6.1-UNIT-008, 6.1-INT-001, 6.1-INT-002

### RISK-002: Display Format Not Preserved (WYSIWYG Failure)
**Mitigated by**: 6.1-INT-024, 6.1-INT-025, 6.1-E2E-007

### RISK-003: Database Migration Data Loss
**Mitigated by**: 6.1-INT-014, 6.1-INT-015, 6.1-INT-016, 6.1-INT-017

### RISK-004: Backward Compatibility Broken
**Mitigated by**: 6.1-INT-022, 6.1-INT-026, 6.1-INT-027, 6.1-INT-029

### RISK-005: API Contract Mismatch
**Mitigated by**: 6.1-INT-019, 6.1-INT-020, 6.1-INT-021

---

## Test Execution Strategy

### Phase 1: Backend Foundation (Before Frontend)
**Duration**: ~1 hour
**Blocker**: Backend migration must pass before frontend work begins

```
SEQUENCE 1: Database Migration Tests (CRITICAL PATH)
├─ 6.1-INT-014 (P0): Verify display_format column added
├─ 6.1-INT-015 (P0): Verify specifications column added
├─ 6.1-INT-016 (P0): Verify rollback works
└─ 6.1-INT-017 (P0): Verify no data loss

SEQUENCE 2: Backend API Tests
├─ 6.1-UNIT-009 (P0): Pydantic validation
├─ 6.1-INT-019 (P0): POST accepts display_format
├─ 6.1-INT-020 (P0): PUT accepts display_format
└─ 6.1-INT-021 (P0): GET returns display_format

GATE: Backend tests must be 100% passing before frontend development
```

### Phase 2: Frontend Unit Tests (Parallel Development)
**Duration**: ~2 hours
**Can run concurrently with dialog development**

```
SEQUENCE 3: Fractional Parser Tests (TDD Approach)
├─ 6.1-UNIT-001 (P0): Decimal parsing
├─ 6.1-UNIT-002 (P0): Mixed fraction parsing
├─ 6.1-UNIT-003 (P0): Hyphenated fraction
├─ 6.1-UNIT-004 (P0): Pure fraction
├─ 6.1-UNIT-005 (P0): Zero denominator rejection
├─ 6.1-UNIT-006 (P1): Format detection
└─ 6.1-UNIT-007 (P1): Improper fractions

SEQUENCE 4: Form Validation Tests
├─ 6.1-UNIT-015 (P0): Negative value rejection
├─ 6.1-UNIT-016 (P0): Zero value rejection
└─ 6.1-UNIT-017 (P0): Decimal precision limit
```

### Phase 3: Integration Tests (After Dialog Implementation)
**Duration**: ~2 hours
**Tests backend-frontend integration**

```
SEQUENCE 5: CRUD Integration Tests
├─ 6.1-INT-001 (P0): Create with fraction format
├─ 6.1-INT-002 (P0): Verify fraction storage
├─ 6.1-INT-003 (P1): Create with decimal format
├─ 6.1-INT-004 (P1): Verify decimal storage
├─ 6.1-INT-024 (P0): Round-trip fraction preservation
└─ 6.1-INT-025 (P0): Round-trip decimal preservation
```

### Phase 4: E2E Tests (Final Validation)
**Duration**: ~1 hour
**Tests complete user workflows**

```
SEQUENCE 6: Critical User Journeys (MUST PASS)
├─ 6.1-E2E-001 (P0): Add dimension workflow
├─ 6.1-E2E-003 (P0): Edit dimension workflow
├─ 6.1-E2E-005 (P0): Delete dimension workflow
└─ 6.1-E2E-007 (P0): WYSIWYG verification

SEQUENCE 7: Secondary Workflows
├─ 6.1-E2E-002 (P1): Decimal format preservation
├─ 6.1-E2E-004 (P1): Error message UX
└─ 6.1-E2E-006 (P1): Specification workflow
```

---

## Test Coverage Gaps & Recommendations

### ✅ Excellent Coverage Areas

1. **Fractional Parser**: 8 unit tests covering all input formats and edge cases
2. **Backend Migration**: 5 integration tests ensuring data safety
3. **API Contract**: 7 integration tests validating backend-frontend coordination
4. **WYSIWYG Behavior**: 3 tests across unit/integration/e2e levels

### ⚠️ Moderate Coverage Gaps

1. **Concurrent Modification**: Story documents edge cases but no explicit tests
   - **Recommendation**: Add 6.1-INT-034 for concurrent edit detection

2. **Network Timeout Handling**: Mentioned in story but not tested
   - **Recommendation**: Add 6.1-E2E-011 for retry UX validation

3. **Mobile Responsiveness**: E2E test exists but P2 priority
   - **Recommendation**: Promote 6.1-E2E-010 to P1 if field engineers use tablets

### 📋 Documentation-Only Coverage (Acceptable)

4. **Pattern Consistency**: Validated through code review (P2)
5. **Code Quality**: Enforced through CI/CD and linting (P2)
6. **Rare Edge Cases** (cases 7-19): Manual testing acceptable (P3)

---

## Test Data Requirements

### Dimensions Test Data

```yaml
test_dimensions:
  - dimension_type: "length"
    nominal_value: 15.75
    display_format: "fraction"
    unit: "in"
    tolerance: "±1/16"

  - dimension_type: "radius"
    nominal_value: 25.4
    display_format: "decimal"
    unit: "mm"
    tolerance: null

  - dimension_type: "length" # Legacy data
    nominal_value: 10.0
    display_format: null # Tests backward compatibility
    unit: "in"
```

### Specifications Test Data

```yaml
test_specifications:
  - specification_type: "material"
    value: "A36 Steel"
    description: "ASTM A36 structural steel"
    display_format: null
```

---

## Recommended Execution Order (CI/CD Pipeline)

```
STAGE 1: Fast Feedback (< 30 seconds)
├─ Unit tests (22 tests)
│  ├─ Fractional parser (7 tests) - P0
│  ├─ Pydantic validation (2 tests) - P0
│  └─ Form validation (11 tests) - P0/P1
└─ GATE: Must pass to proceed

STAGE 2: Integration (< 5 minutes)
├─ Backend migration (5 tests) - P0
├─ API contract (7 tests) - P0
├─ CRUD operations (6 tests) - P0/P1
└─ GATE: Must pass to deploy

STAGE 3: E2E Smoke (< 10 minutes)
├─ Critical journeys (4 tests) - P0
└─ GATE: Must pass for production

STAGE 4: Full E2E (< 20 minutes)
├─ Secondary workflows (3 tests) - P1
└─ Responsive UX (3 tests) - P2
└─ GATE: Optional (can waive for hotfixes)
```

---

## Test Maintenance Considerations

### High Maintenance Risk Tests
- **6.1-E2E-*** (All E2E tests): Brittle due to UI changes
  - **Mitigation**: Use data-testid attributes, avoid CSS selectors
  - **Mitigation**: Implement page object pattern

### Low Maintenance Risk Tests
- **6.1-UNIT-*** (Parser tests): Stable algorithm, no external dependencies
- **6.1-INT-*** (API tests): Stable contracts, versioned APIs

### Flakiness Prevention
- **6.1-INT-028** (Cache invalidation): May be flaky due to timing
  - **Mitigation**: Use explicit wait conditions, not arbitrary delays

- **6.1-E2E-002** (Page reload): May be flaky in CI/CD
  - **Mitigation**: Wait for network idle, verify data loaded

---

## Success Criteria

### Definition of Done for Testing

✅ **P0 Tests**: 21 tests, 100% passing required
✅ **P1 Tests**: 19 tests, 95% passing acceptable (1 flake tolerated)
✅ **P2 Tests**: 7 tests, best effort (can waive if blocked)

✅ **Coverage Targets Met**:
- Unit test coverage: >90% for parser utility
- Integration test coverage: >80% for API endpoints
- E2E test coverage: All critical user journeys

✅ **Quality Gates**:
- No P0 test failures
- No regression in existing dimension display
- Backend migration tested with rollback
- WYSIWYG behavior verified end-to-end

---

## Appendix A: Test ID Reference

### Test Level Distribution

| Level | P0 | P1 | P2 | Total |
|-------|----|----|----|----|
| Unit | 10 | 9 | 3 | 22 |
| Integration | 11 | 6 | 1 | 18 |
| E2E | 5 | 2 | 3 | 10* |

*Note: E2E tests 8-10 are validation tests, not new implementation tests.

### Priority Distribution by Functional Area

| Area | P0 | P1 | P2 | Total |
|------|----|----|----|----|
| Fractional Parser | 5 | 2 | 1 | 8 |
| Backend Migration | 5 | 1 | 0 | 6 |
| API Contract | 7 | 2 | 0 | 9 |
| CRUD Operations | 6 | 7 | 0 | 13 |
| UX/Validation | 3 | 5 | 6 | 14 |

---

## Appendix B: Test Scenarios Quick Reference

**P0 MUST-TEST (21 scenarios)**:
- Fractional parser: UNIT-001 to UNIT-005
- Pydantic validation: UNIT-009
- Form validation: UNIT-015 to UNIT-017
- Backend migration: INT-014 to INT-017
- API contract: INT-019 to INT-021
- Display format: INT-024, INT-025
- CRUD operations: INT-001, INT-002, INT-009, INT-027
- E2E journeys: E2E-001, E2E-003, E2E-005, E2E-007

**P1 SHOULD-TEST (19 scenarios)**:
- Parser edge cases: UNIT-006, UNIT-007
- API defaults: INT-018, INT-022, INT-023
- CRUD operations: INT-003 to INT-008, INT-011 to INT-013
- Cache/compatibility: INT-028, INT-029
- UX feedback: UNIT-020, UNIT-021, INT-032
- E2E workflows: E2E-002, E2E-004, E2E-006

**P2 NICE-TO-HAVE (7 scenarios)**:
- Pattern consistency: UNIT-013, UNIT-014
- Complex edge cases: UNIT-008
- Code quality: UNIT-022, INT-033
- Responsive UX: E2E-009, E2E-010

---

**Test Design Complete**
**Status**: Ready for Implementation
**Next Steps**: Begin backend migration tests (SEQUENCE 1), followed by parser TDD (SEQUENCE 3)
