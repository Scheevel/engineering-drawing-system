# Test Design: Story 6.2 - Integrate Dimension & Specification Dialogs with UI

**Date**: 2025-10-13
**Designer**: Quinn (Test Architect)
**Story**: 6.2 - Integrate Dimension & Specification Dialogs with UI
**Epic**: 6 - Dimension & Specification Management

---

## Test Strategy Overview

**Summary**: Integration-focused testing to validate dialog wiring, state management, and user workflows. Story 6.1 already tested dialogs in isolation (33 tests); this story tests UI integration.

### Test Distribution

- **Total test scenarios**: 22
- **Unit tests**: 8 (36%)
- **Integration tests**: 11 (50%)
- **E2E tests**: 3 (14%)
- **Priority distribution**: P0: 11, P1: 8, P2: 3

### Test Philosophy

**Shift Left**: Unit test handler functions, integration test dialog interactions, E2E test critical user journey
**Risk-Based**: Focus on state management bugs (dialog not opening, incorrect data loading)
**Efficient Coverage**: Avoid redundant testing - Story 6.1 already tested dialog internals

---

## Test Scenarios by Acceptance Criteria

### AC1: Add Dimension Integration
**Requirement**: Clicking "Add Dimension" button in ComponentDimensions opens DimensionFormDialog

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-UNIT-001 | Unit | P0 | handleAddClick sets editingDimension to null | Pure function logic - fast, deterministic |
| 6.2-UNIT-002 | Unit | P0 | handleAddClick sets dialogOpen to true | State transition validation |
| 6.2-INT-001 | Integration | P0 | Clicking "Add Dimension" button opens DimensionFormDialog component | Multi-component interaction - button → state → dialog |
| 6.2-INT-002 | Integration | P0 | Dialog receives correct props (componentId, dimension=null, open=true) | Prop passing validation |
| 6.2-E2E-001 | E2E | P1 | User journey: Search → View → Edit → Dimensions → Add → Dialog opens | Critical path - already exists in `dimension-entry-workflow.spec.ts` |

**Coverage**: 5 tests (2 unit, 2 integration, 1 e2e)
**Risk Mitigation**: Dialog not opening (RISK-001), Incorrect mode (RISK-002)

---

### AC2: Edit Dimension Integration
**Requirement**: Clicking edit icon on existing dimension opens DimensionFormDialog with pre-populated data

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-UNIT-003 | Unit | P0 | handleEditClick sets editingDimension to selected dimension | Pure function logic |
| 6.2-UNIT-004 | Unit | P0 | handleEditClick sets dialogOpen to true | State transition validation |
| 6.2-INT-003 | Integration | P0 | Clicking edit icon opens dialog with dimension data | Multi-component interaction |
| 6.2-INT-004 | Integration | P0 | Dialog receives correct props (componentId, dimension=selected, open=true) | Prop passing with data |
| 6.2-INT-005 | Integration | P1 | Dialog form fields pre-populated with dimension values | Verify data binding |

**Coverage**: 5 tests (2 unit, 3 integration)
**Risk Mitigation**: Data not loading (RISK-003), Wrong dimension selected (RISK-004)

---

### AC3: Delete Dimension Confirmation
**Requirement**: Clicking delete icon prompts for confirmation before deletion

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-UNIT-005 | Unit | P0 | handleDeleteClick sets dimensionToDelete to dimension ID | Pure function logic |
| 6.2-UNIT-006 | Unit | P0 | handleDeleteClick sets deleteDialogOpen to true | State transition |
| 6.2-INT-006 | Integration | P0 | Clicking delete icon opens confirmation dialog | Multi-component interaction |
| 6.2-INT-007 | Integration | P0 | Confirmation dialog shows dimension details | Data display validation |
| 6.2-INT-008 | Integration | P0 | Clicking "Cancel" closes dialog without calling deleteDimension API | Cancel behavior |
| 6.2-INT-009 | Integration | P0 | Clicking "Delete" calls deleteDimension API and closes dialog | Delete execution |

**Coverage**: 6 tests (2 unit, 4 integration)
**Risk Mitigation**: Accidental deletion (RISK-005), API not called (RISK-006)

---

### AC4-6: Specification Integration
**Requirement**: Same pattern as dimensions for specifications (Add, Edit, Delete)

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-INT-010 | Integration | P1 | ComponentSpecifications exists and follows same pattern | Verify file structure |
| 6.2-INT-011 | Integration | P2 | If ComponentSpecifications missing, story documents gap | Contingency handling |

**Coverage**: 2 tests (2 integration)
**Note**: If ComponentSpecifications doesn't exist, AC4-6 are documented as future work
**Risk Mitigation**: Pattern inconsistency (RISK-007)

---

### AC7: Data Refresh
**Requirement**: After saving or deleting, the dimension/specification list automatically refreshes

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-UNIT-007 | Unit | P0 | handleSave calls onUpdate callback | Pure function behavior |
| 6.2-UNIT-008 | Unit | P0 | handleConfirmDelete calls onUpdate after API success | Callback chaining |
| 6.2-E2E-002 | E2E | P0 | After saving dimension, new dimension appears in list without manual refresh | End-to-end data flow validation |

**Coverage**: 3 tests (2 unit, 1 e2e)
**Risk Mitigation**: Stale data (RISK-008), Cache not invalidated (RISK-009)

---

### AC8: Dialog Close
**Requirement**: Clicking cancel or close icon dismisses dialog without saving

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-INT-012 | Integration | P1 | Clicking cancel button closes dialog | User interaction |
| 6.2-INT-013 | Integration | P1 | Clicking X icon closes dialog | Alternative close method |
| 6.2-INT-014 | Integration | P1 | Closing dialog does NOT call onUpdate | Prevent unnecessary refresh |
| 6.2-INT-015 | Integration | P2 | Pressing ESC key closes dialog | Keyboard accessibility |

**Coverage**: 4 tests (4 integration)
**Risk Mitigation**: Data saved on cancel (RISK-010), No escape route (RISK-011)

---

### AC9: E2E Test Validation
**Requirement**: The e2e/dimension-entry-workflow.spec.ts test passes

#### Test Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 6.2-E2E-003 | E2E | P0 | Run dimension-entry-workflow.spec.ts and verify all tests pass | Acceptance validation |

**Coverage**: 1 test (1 e2e)
**Note**: Test currently skips due to missing integration - must pass after implementation
**Test Location**: `frontend/e2e/dimension-entry-workflow.spec.ts`
**Risk Mitigation**: Integration incomplete (RISK-012)

---

## Risk Coverage Matrix

### Identified Risks

| Risk ID | Risk Description | Probability | Impact | Score | Mitigating Tests |
|---------|------------------|-------------|--------|-------|------------------|
| RISK-001 | Dialog doesn't open when button clicked | High | High | 9 | 6.2-INT-001, 6.2-E2E-001 |
| RISK-002 | Dialog opens in wrong mode (add vs edit) | Medium | High | 6 | 6.2-UNIT-001, 6.2-UNIT-003, 6.2-INT-002, 6.2-INT-004 |
| RISK-003 | Edit dialog doesn't pre-populate data | Medium | Medium | 4 | 6.2-INT-003, 6.2-INT-005 |
| RISK-004 | Wrong dimension selected for edit/delete | Low | High | 5 | 6.2-UNIT-003, 6.2-UNIT-005 |
| RISK-005 | Dimension deleted without confirmation | Low | Critical | 7 | 6.2-INT-006, 6.2-INT-008 |
| RISK-006 | Delete API not called after confirmation | Medium | High | 6 | 6.2-INT-009 |
| RISK-007 | Specifications don't follow same pattern | Low | Medium | 3 | 6.2-INT-010 |
| RISK-008 | List doesn't refresh after save/delete | Medium | High | 6 | 6.2-UNIT-007, 6.2-UNIT-008, 6.2-E2E-002 |
| RISK-009 | React Query cache not invalidated | Medium | Medium | 4 | 6.2-E2E-002 |
| RISK-010 | Cancel button saves data | Low | Medium | 3 | 6.2-INT-014 |
| RISK-011 | No keyboard escape from dialog | Low | Low | 1 | 6.2-INT-015 |
| RISK-012 | E2E test still fails after implementation | Medium | High | 6 | 6.2-E2E-003 |

**Total Risk Score**: 60
**High Priority Risks** (Score ≥6): 6/12 (50%)
**Test Coverage**: All risks have mitigating tests

---

## Test Implementation Plan

### Phase 1: Unit Tests (P0 - Fail Fast)
**File**: `frontend/src/components/editor/ComponentDimensions.test.tsx`

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import ComponentDimensions from './ComponentDimensions';

describe('ComponentDimensions Handler Functions', () => {
  describe('handleAddClick', () => {
    it('6.2-UNIT-001: sets editingDimension to null', () => {
      // Test pure function logic
    });

    it('6.2-UNIT-002: sets dialogOpen to true', () => {
      // Test state transition
    });
  });

  describe('handleEditClick', () => {
    it('6.2-UNIT-003: sets editingDimension to selected dimension', () => {
      // Test with mock dimension
    });

    it('6.2-UNIT-004: sets dialogOpen to true', () => {
      // Test state transition
    });
  });

  describe('handleDeleteClick', () => {
    it('6.2-UNIT-005: sets dimensionToDelete to dimension ID', () => {
      // Test with mock dimension ID
    });

    it('6.2-UNIT-006: sets deleteDialogOpen to true', () => {
      // Test state transition
    });
  });

  describe('handleSave', () => {
    it('6.2-UNIT-007: calls onUpdate callback', () => {
      // Test callback invocation
    });
  });

  describe('handleConfirmDelete', () => {
    it('6.2-UNIT-008: calls onUpdate after API success', () => {
      // Test async callback with mock API
    });
  });
});
```

**Expected Duration**: 30 minutes
**Success Criteria**: All 8 unit tests pass in <1 second

---

### Phase 2: Integration Tests (P0 - Component Interactions)
**File**: `frontend/src/components/editor/ComponentDimensions.integration.test.tsx`

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from 'react-query';
import ComponentDimensions from './ComponentDimensions';

describe('ComponentDimensions Dialog Integration', () => {
  const mockComponent = { id: 'test-123' };
  const mockDimension = {
    id: 'dim-1',
    dimension_type: 'length',
    nominal_value: '15.75',
    display_format: 'fraction'
  };

  describe('Add Dimension Flow', () => {
    it('6.2-INT-001: Clicking Add button opens DimensionFormDialog', async () => {
      // Render component, click button, verify dialog visible
    });

    it('6.2-INT-002: Dialog receives correct props for add mode', () => {
      // Verify componentId, dimension=null, open=true
    });
  });

  describe('Edit Dimension Flow', () => {
    it('6.2-INT-003: Clicking edit icon opens dialog with data', async () => {
      // Render with existing dimension, click edit, verify dialog
    });

    it('6.2-INT-004: Dialog receives correct props for edit mode', () => {
      // Verify componentId, dimension=selected, open=true
    });

    it('6.2-INT-005: Dialog form pre-populated with values', async () => {
      // Verify form fields show dimension data
    });
  });

  describe('Delete Dimension Flow', () => {
    it('6.2-INT-006: Clicking delete icon opens confirmation dialog', () => {
      // Verify confirmation dialog appears
    });

    it('6.2-INT-007: Confirmation dialog shows dimension details', () => {
      // Verify dimension ID or name displayed
    });

    it('6.2-INT-008: Cancel closes dialog without API call', async () => {
      // Mock deleteDimension, verify not called
    });

    it('6.2-INT-009: Delete calls API and closes dialog', async () => {
      // Mock deleteDimension, verify called with correct ID
    });
  });

  describe('Specification Pattern', () => {
    it('6.2-INT-010: ComponentSpecifications follows same pattern', () => {
      // Verify file exists and has same structure
    });

    it('6.2-INT-011: Documents gap if ComponentSpecifications missing', () => {
      // Conditional test - pass if documented
    });
  });

  describe('Dialog Close Behavior', () => {
    it('6.2-INT-012: Cancel button closes dialog', () => {
      // Test cancel button
    });

    it('6.2-INT-013: X icon closes dialog', () => {
      // Test close icon
    });

    it('6.2-INT-014: Close does NOT call onUpdate', () => {
      // Verify onUpdate not invoked on cancel
    });

    it('6.2-INT-015: ESC key closes dialog', () => {
      // Test keyboard escape
    });
  });
});
```

**Expected Duration**: 1-2 hours
**Success Criteria**: All 11 integration tests pass in <5 seconds

---

### Phase 3: E2E Tests (P0 - Critical User Journey)

#### Existing Test (Must Pass)
**File**: `frontend/e2e/dimension-entry-workflow.spec.ts`

```typescript
// This test already exists and currently skips
// After implementation, it must execute and pass

describe('Dimension Entry Workflow', () => {
  test('6.2-E2E-001: should allow dimension entry with edit workflow', async ({ page }) => {
    // Navigate → Search → View → Edit → Dimensions → Add
    // Currently SKIPS - must PASS after implementation
  });

  test('6.2-E2E-002: should refresh list after save', async ({ page }) => {
    // Add dimension → Save → Verify appears in list without refresh
  });

  test('6.2-E2E-003: validate all test scenarios execute', async ({ page }) => {
    // Run full test suite and verify no skips
  });
});
```

**Expected Duration**: 30 minutes (already written, just verify pass)
**Success Criteria**: All 3 E2E tests pass in <30 seconds

---

## Recommended Execution Order

### Pre-Commit (Local Development)
1. **6.2-UNIT-001 to 6.2-UNIT-008** (8 tests, <1 sec)
2. **6.2-INT-001 to 6.2-INT-015** (11 tests, <5 sec)

### CI/CD Pipeline
1. **P0 Unit tests** (8 tests) - Fail fast if logic broken
2. **P0 Integration tests** (9 tests) - Validate component wiring
3. **P0 E2E tests** (3 tests) - Validate critical path
4. **P1 Integration tests** (2 tests) - Secondary features
5. **P2 tests** (2 tests) - Nice-to-have coverage

**Total Execution Time**: <40 seconds (unit + integration + e2e)

---

## Test Coverage Analysis

### Coverage by Acceptance Criteria

| AC | Description | Tests | Unit | Integration | E2E |
|----|-------------|-------|------|-------------|-----|
| AC1 | Add Dimension | 5 | 2 | 2 | 1 |
| AC2 | Edit Dimension | 5 | 2 | 3 | 0 |
| AC3 | Delete Confirmation | 6 | 2 | 4 | 0 |
| AC4-6 | Specifications | 2 | 0 | 2 | 0 |
| AC7 | Data Refresh | 3 | 2 | 0 | 1 |
| AC8 | Dialog Close | 4 | 0 | 4 | 0 |
| AC9 | E2E Validation | 1 | 0 | 0 | 1 |
| **Total** | **All ACs** | **22** | **8** | **11** | **3** |

**Coverage Gaps**: None - all ACs have test coverage
**Over-Testing**: None - tests focused on integration, Story 6.1 covered dialog internals

---

## Test Pyramid Compliance

```
    /\
   /E2E\      3 tests (14%) - Critical user journey
  /────\
 / INT  \    11 tests (50%) - Primary focus: dialog wiring
/────────\
/  UNIT   \   8 tests (36%) - Handler function logic
───────────
```

**Analysis**:
- ✅ **Shift Left**: 86% tests at unit/integration level
- ✅ **Efficient**: Only 3 E2E tests for critical path
- ✅ **Fast Feedback**: Most tests <5 seconds total
- ✅ **Maintainable**: Integration tests focus on this story's scope

---

## Dependencies on Story 6.1 Tests

Story 6.1 already tested (40 passing tests):
- **Backend**: 7 tests (migration, Pydantic validation, API contracts)
- **Frontend**: 33 tests (fractional parser with GCD algorithm)

**This story does NOT re-test**:
- ❌ Fractional input parsing (covered by Story 6.1)
- ❌ Form validation in DimensionFormDialog (covered by Story 6.1)
- ❌ Database schema changes (covered by Story 6.1)
- ❌ API endpoints (covered by Story 6.1)

**This story DOES test**:
- ✅ Dialog opening/closing from UI buttons
- ✅ State management (dialogOpen, editingDimension)
- ✅ Prop passing (componentId, dimension, onSave)
- ✅ Data refresh after save/delete
- ✅ User workflow integration (E2E)

---

## Quality Checklist

- [x] Every AC has test coverage (9/9 ACs covered)
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels (Story 6.1 vs 6.2 scoped)
- [x] Priorities align with business risk (P0 for critical dialog wiring)
- [x] Test IDs follow naming convention (6.2-UNIT-001, etc.)
- [x] Scenarios are atomic and independent (each test stands alone)
- [x] Fast feedback (<40 sec total execution time)
- [x] Risk mitigation addressed (all 12 risks have tests)

---

## Success Metrics

### Definition of Done (Testing Perspective)

1. ✅ All 8 unit tests pass (<1 sec)
2. ✅ All 11 integration tests pass (<5 sec)
3. ✅ All 3 E2E tests pass (<30 sec)
4. ✅ `dimension-entry-workflow.spec.ts` executes without skipping
5. ✅ Test coverage > 80% for modified files
6. ✅ Zero regressions in Story 6.1 tests

### Test Execution Commands

```bash
# Unit + Integration tests
cd frontend
npm test -- ComponentDimensions

# E2E tests
cd frontend
npx playwright test dimension-entry-workflow.spec.ts --project=chromium

# Full test suite
npm test
npx playwright test
```

---

## Maintenance Considerations

### Test Longevity
- **Low Maintenance**: Tests focus on public interfaces (button clicks, dialogs)
- **Resilient**: Uses data-testid attributes (Story 6.1 pattern)
- **Self-Documenting**: Test names clearly describe behavior

### Test Refactoring Triggers
- If dialog prop signatures change in Story 6.1 dialogs
- If ComponentDimensions component is refactored
- If React Query upgrade changes cache invalidation

---

## Gate YAML Block (for quality-gate.yml)

```yaml
test_design:
  story: '6.2'
  date: '2025-10-13'
  designer: Quinn
  scenarios_total: 22
  by_level:
    unit: 8
    integration: 11
    e2e: 3
  by_priority:
    p0: 11
    p1: 8
    p2: 3
  coverage_gaps: []
  risk_mitigation:
    risks_identified: 12
    risks_with_tests: 12
    coverage_percentage: 100
  execution_time_estimate: '<40 seconds'
  pyramid_compliance: 'PASS'
  dependencies:
    story_6_1_tests: 40
    story_6_1_status: 'PASS (archived)'
```

---

## Recommendations

### Critical (P0)
1. **Implement all 8 unit tests first** - Fast failure detection
2. **Run E2E test frequently** - It's the acceptance criterion (AC9)
3. **Mock API calls in integration tests** - Avoid backend dependency

### Important (P1)
1. Add test data fixtures for consistent dimension objects
2. Use data-testid attributes for stable selectors (follow Story 6.1 pattern)
3. Test keyboard navigation (TAB, ESC, ENTER)

### Nice-to-Have (P2)
1. Visual regression tests for dialog appearance
2. Performance tests for dialog open latency (<100ms)
3. Accessibility tests (screen reader compatibility)

---

## Test Design Complete

**Status**: ✅ **READY FOR IMPLEMENTATION**

**Next Steps**:
1. Dev agent implements integration following story tasks
2. Dev agent writes 8 unit tests (Phase 1)
3. Dev agent writes 11 integration tests (Phase 2)
4. Dev agent runs existing E2E test to verify AC9
5. QA agent validates all 22 tests pass during review

**Estimated Test Implementation Time**: 2-3 hours
**Test Execution Time**: <40 seconds total
**Risk Coverage**: 100% (12/12 risks mitigated)
