# Test Implementation Plan: Story 3.13 Phase 2 & 3

**Story**: 3.13 Schema Refactoring - Phase 2 & 3 Test Coverage
**Created**: 2025-09-30
**Estimated Total Effort**: 15-20 hours
**Priority**: P1 (Blocker for Production)

## Executive Summary

Story 3.13 has excellent implementation quality but lacks test coverage for Phase 2 (FR-3, FR-5) and Phase 3 (FR-6, FR-7). This plan provides a structured approach to completing the missing tests, organized by priority and implementation order.

**Current State**:
- Phase 1: ✅ 145+ test cases (comprehensive)
- Phase 2: ❌ 0 test cases
- Phase 3: ❌ 0 test cases

**Goal**: Achieve 80%+ test coverage for all acceptance criteria (AC 11-40)

---

## Test Files Created

Four test stub files have been created with comprehensive test case outlines:

1. **`frontend/src/hooks/schema/__tests__/useSchemaDirtyState.test.ts`**
   - Coverage: FR-3 AC 11-16 (dirty state detection)
   - Type: Unit/Integration tests for React hook
   - Estimated: 3-4 hours

2. **`frontend/src/components/flexible/__tests__/SchemaAwareForm.multiselect.test.tsx`**
   - Coverage: FR-5 AC 22-27 (multi-select field rendering)
   - Type: Integration tests with React Testing Library
   - Estimated: 4-5 hours

3. **`backend/tests/test_default_schema_protection.py`**
   - Coverage: FR-6 AC 28-33 (default schema protection)
   - Type: Backend API tests + Frontend UI tests
   - Estimated: 4-5 hours

4. **`backend/tests/test_schema_deletion_workflow.py`**
   - Coverage: FR-7 AC 34-40 (schema deletion with dependency checking)
   - Type: Backend API tests + Frontend UI tests
   - Estimated: 4-5 hours

---

## Implementation Order

### Priority 1: Critical Path (8-10 hours)

These tests cover the highest-risk functionality and should be implemented first.

#### Week 1 - Day 1-2: Backend Protection Tests (4-5 hours)

**File**: `backend/tests/test_default_schema_protection.py`

**Rationale**: Backend protection is a **security and data integrity concern**. Default schemas must not be modifiable, and this must be enforced server-side first.

**Implementation Steps**:

1. **Setup Test Fixtures** (30 min)
   - Create `default_schema` fixture with `is_default=True`
   - Create `editable_schema` fixture with `is_default=False`
   - Ensure proper database cleanup between tests

2. **FR-6 AC 29: Update Protection** (1 hour)
   ```python
   # Tests to implement:
   - test_cannot_update_default_schema_name()
   - test_cannot_update_default_schema_description()
   - test_can_update_editable_schema_metadata()
   ```
   **Focus**: Verify 400 error with correct message, verify database unchanged

3. **FR-6 AC 30-31: Delete and Field Protection** (1.5 hours)
   ```python
   # Tests to implement:
   - test_cannot_delete_default_schema()
   - test_cannot_add_field_to_default_schema()
   - test_cannot_update_field_in_default_schema()
   - test_cannot_delete_field_from_default_schema()
   ```
   **Focus**: All operations blocked with consistent error messages

4. **FR-6 AC 33: Duplication** (1.5 hours)
   ```python
   # Tests to implement:
   - test_duplicate_default_schema_creates_editable_copy()
   - test_duplicate_copies_all_field_properties()
   - test_duplicate_without_name_generates_default_name()
   ```
   **Focus**: Verify new schema has `is_default=False`, all fields copied correctly

5. **E2E Test** (30 min)
   ```python
   - test_default_schema_protection_end_to_end()
   ```
   **Focus**: Full workflow from blocked edit → duplicate → successful edit

**Success Criteria**:
- All protection endpoints return 400 with clear messages
- Duplication creates editable copies
- Default schemas remain unmodified
- pytest suite passes with 15+ tests green

---

#### Week 1 - Day 3-4: Deletion Workflow Tests (4-5 hours)

**File**: `backend/tests/test_schema_deletion_workflow.py`

**Rationale**: Deletion with dependency checking prevents **data loss and referential integrity issues**. This is critical for production safety.

**Implementation Steps**:

1. **Setup Test Fixtures** (30 min)
   - Create `unused_schema` fixture
   - Create `schema_with_components` fixture with 3 components
   - Helper functions for component creation

2. **FR-7 AC 34: Usage Checking** (1 hour)
   ```python
   # Tests to implement:
   - test_get_schema_usage_returns_zero_for_unused_schema()
   - test_get_schema_usage_returns_count_for_active_schema()
   - test_get_schema_usage_handles_large_component_lists()
   ```
   **Focus**: API returns accurate component counts

3. **FR-7 AC 35: Deletion Blocking** (1.5 hours)
   ```python
   # Tests to implement:
   - test_cannot_delete_schema_with_components()
   - test_can_delete_unused_schema()
   - test_error_message_shows_exact_component_count()
   ```
   **Focus**: Deletion blocked when components exist, succeeds when unused

4. **FR-7 AC 36: Reassignment** (1 hour)
   ```python
   # Tests to implement:
   - test_manually_reassign_components_then_delete()
   ```
   **Focus**: Workflow of reassigning components then deleting schema

5. **FR-7 AC 38: Soft Delete** (1 hour)
   ```python
   # Tests to implement:
   - test_deletion_is_soft_delete_not_hard_delete()
   - test_soft_deleted_schema_not_shown_in_listings()
   - test_components_cannot_use_soft_deleted_schema()
   ```
   **Focus**: Verify `is_active=False`, not removed from database

6. **E2E Test** (30 min)
   ```python
   - test_complete_deletion_workflow_end_to_end()
   ```

**Success Criteria**:
- Usage API returns accurate counts
- Deletion blocked when components exist
- Soft delete implementation verified
- pytest suite passes with 12+ tests green

---

### Priority 2: User Experience Tests (7-10 hours)

These tests ensure the user-facing features work correctly and can be implemented after P1.

#### Week 2 - Day 1-2: Dirty State Detection Tests (3-4 hours)

**File**: `frontend/src/hooks/schema/__tests__/useSchemaDirtyState.test.ts`

**Rationale**: Dirty state detection prevents **data loss** from accidental navigation away from unsaved changes.

**Implementation Steps**:

1. **Setup Test Utilities** (30 min)
   - Create mock schema fixtures
   - Setup `@testing-library/react-hooks` renderHook utility
   - Helper functions for field manipulation

2. **FR-3 AC 11-12: Initial State & Form Changes** (30 min)
   ```typescript
   // Tests to implement:
   - should return isDirty=false when initialized with unchanged data
   - should return isDirty=true when formIsDirty is true
   ```

3. **FR-3 AC 13-16: Field Operations** (1.5 hours)
   ```typescript
   // Tests to implement (4 tests per operation × 4 operations):
   - Field addition detection
   - Field removal detection
   - Field modification detection
   - Field reordering detection
   - Manual marking via markFieldsAsDirty()
   ```
   **Focus**: Each change type detected, changeTypes array populated correctly

4. **Edge Cases** (1 hour)
   ```typescript
   // Tests to implement:
   - Handle undefined/null initial schema
   - Multiple change types simultaneously
   - Reset when reverted to initial state
   - Combined form + field changes
   ```

5. **Performance Tests** (30 min)
   ```typescript
   - Efficient detection with 50+ fields
   - No unnecessary re-renders
   ```

**Success Criteria**:
- All 6 change detection scenarios tested
- Edge cases handled gracefully
- Jest suite passes with 15+ tests green
- Test coverage >85% for useSchemaDirtyState.ts

---

#### Week 2 - Day 3-4: Multi-Select Field Tests (4-5 hours)

**File**: `frontend/src/components/flexible/__tests__/SchemaAwareForm.multiselect.test.tsx`

**Rationale**: Multi-select is a **new field type** added in Phase 2. Testing ensures it works consistently with other field types.

**Implementation Steps**:

1. **Setup Test Environment** (45 min)
   - Create QueryClient wrapper
   - Create schema fixtures with multiselect field
   - Setup user-event library for interactions

2. **FR-5 AC 22: Rendering** (1 hour)
   ```typescript
   // Tests to implement:
   - should render multi-select field with correct label
   - should display all options from field_config
   - should support selecting multiple values
   ```
   **Focus**: Material-UI Autocomplete renders correctly with `multiple={true}`

3. **FR-5 AC 23: Default Values** (1 hour)
   ```typescript
   // Tests to implement:
   - should initialize with empty array when no default provided
   - should initialize with field_config.default_value if provided
   - should handle default_value as single string
   ```
   **Focus**: No controlled/uncontrolled component warnings

4. **FR-5 AC 24: Validation** (1.5 hours)
   ```typescript
   // Tests to implement:
   - should validate required multi-select fields
   - should enforce minimum selection count
   - should enforce maximum selection count
   - should pass validation when within constraints
   ```
   **Focus**: React Hook Form validation rules work correctly

5. **FR-5 AC 25: User Interactions** (1 hour)
   ```typescript
   // Tests to implement:
   - should allow removing selected values by clicking chip delete
   - should allow clearing all selections
   - should support keyboard navigation
   - should support search/filter functionality
   ```
   **Focus**: All user interaction patterns work as expected

6. **FR-5 AC 26-27: Form Submission & Edit Mode** (30 min)
   ```typescript
   // Tests to implement:
   - should submit array of selected values
   - should preserve selection order
   - should pre-populate with existing component data
   - should allow modifying pre-populated selections
   ```

**Success Criteria**:
- All Material-UI Autocomplete interactions tested
- Validation rules verified
- Form submission produces correct data structure
- Jest suite passes with 20+ tests green
- Test coverage >80% for multiselect rendering code

---

## Testing Tools & Setup

### Frontend Testing Stack

```bash
# Dependencies (already installed)
- @testing-library/react
- @testing-library/user-event
- @testing-library/jest-dom
- jest
- react-query (with test utilities)

# Running tests
cd frontend
npm test                                    # Run all tests
npm test -- useSchemaDirtyState.test.ts    # Run specific test file
npm test -- --coverage                      # Coverage report
```

### Backend Testing Stack

```bash
# Dependencies (already installed)
- pytest
- pytest-asyncio
- FastAPI TestClient
- SQLAlchemy test database

# Running tests
cd backend
pytest tests/test_default_schema_protection.py -v
pytest tests/test_schema_deletion_workflow.py -v
pytest tests/ -v --cov=app.services.schema_service --cov-report=html
```

---

## Test Coverage Goals

### By Acceptance Criteria

| Feature | ACs | Tests Required | Status |
|---------|-----|----------------|--------|
| **FR-3**: Dirty State | AC 11-16 | 15+ unit tests | 🟡 Stub created |
| **FR-5**: Multi-Select | AC 22-27 | 20+ integration tests | 🟡 Stub created |
| **FR-6**: Protection | AC 28-33 | 15+ API + UI tests | 🟡 Stub created |
| **FR-7**: Deletion | AC 34-40 | 12+ API + UI tests | 🟡 Stub created |

**Target**: 62+ tests total across all four areas

### By Test Type

- **Unit Tests**: 15-20 (isolated logic testing)
- **Integration Tests**: 25-30 (component + API integration)
- **E2E Tests**: 5-8 (complete user workflows)
- **Service Layer Tests**: 10-12 (direct service method testing)

---

## Implementation Checklist

### Phase 2 Tests (FR-3, FR-5)

- [ ] **useSchemaDirtyState Hook Tests** (3-4 hours)
  - [ ] Initial clean state tests (AC 11)
  - [ ] Form metadata change detection (AC 12)
  - [ ] Field addition detection (AC 13)
  - [ ] Field removal detection (AC 14)
  - [ ] Field modification detection (AC 15)
  - [ ] Field reordering detection (AC 16)
  - [ ] Edge cases and combined scenarios
  - [ ] Performance tests

- [ ] **Multi-Select Field Tests** (4-5 hours)
  - [ ] Rendering with Autocomplete (AC 22)
  - [ ] Default value handling (AC 23)
  - [ ] Validation rules (AC 24)
  - [ ] User interaction workflows (AC 25)
  - [ ] Form submission integration (AC 26)
  - [ ] Edit mode with existing values (AC 27)
  - [ ] Edge cases

### Phase 3 Tests (FR-6, FR-7)

- [ ] **Default Schema Protection Tests** (4-5 hours)
  - [ ] is_default flag in API responses (AC 28)
  - [ ] Update blocking (AC 29)
  - [ ] Delete blocking (AC 30)
  - [ ] Field operation blocking (AC 31)
  - [ ] Error message guidance (AC 32)
  - [ ] Duplication functionality (AC 33)
  - [ ] Frontend UI protection elements
  - [ ] E2E protection workflow

- [ ] **Schema Deletion Workflow Tests** (4-5 hours)
  - [ ] Usage checking API (AC 34)
  - [ ] Deletion blocking with components (AC 35)
  - [ ] Reassignment workflow (AC 36)
  - [ ] Error messages with counts (AC 37)
  - [ ] Soft delete implementation (AC 38)
  - [ ] Default schema deletion blocked (AC 39)
  - [ ] Cascade deletion handling (AC 40)
  - [ ] E2E deletion workflow

### Quality Gates

- [ ] All test suites pass (frontend & backend)
- [ ] Test coverage ≥80% for modified files
- [ ] No skipped or commented-out tests
- [ ] E2E workflows verified end-to-end
- [ ] Run tests in CI/CD pipeline
- [ ] Update story File List with test files
- [ ] Request QA re-review

---

## Risk Mitigation

### High-Risk Areas Requiring Extra Testing

1. **Default Schema Protection** (FR-6)
   - **Risk**: Unauthorized modification of system schemas could corrupt data
   - **Mitigation**: Comprehensive backend validation + frontend UI reinforcement
   - **Extra Tests**: Attempt every possible mutation method, verify all blocked

2. **Schema Deletion** (FR-7)
   - **Risk**: Deleting schema in use breaks referential integrity
   - **Mitigation**: Usage checking before deletion, soft delete pattern
   - **Extra Tests**: Race condition tests, concurrent access scenarios

3. **Dirty State Detection** (FR-3)
   - **Risk**: False negatives cause data loss, false positives annoy users
   - **Mitigation**: Test all 6 change types + edge cases
   - **Extra Tests**: Combined changes, revert scenarios, performance with large datasets

---

## Success Metrics

### Definition of Done

✅ **Test Implementation Complete** when:
1. All 62+ test cases implemented (not just TODO stubs)
2. Test suites pass with 0 failures
3. Code coverage ≥80% for Phase 2 & 3 code
4. E2E workflows verified manually once before automation
5. No known bugs in tested functionality

### Quality Gate Pass Criteria

To move from **CONCERNS → PASS**:
- All P1 tests implemented and passing (8-10 hours)
- All P2 tests implemented and passing (7-10 hours)
- Manual QA spot-check of critical workflows
- Story updated with test results
- QA re-review issues **PASS** gate

---

## Appendix: Quick Reference

### Running Individual Test Files

```bash
# Frontend
cd frontend
npm test -- useSchemaDirtyState.test.ts
npm test -- SchemaAwareForm.multiselect.test.tsx

# Backend
cd backend
pytest tests/test_default_schema_protection.py -v
pytest tests/test_schema_deletion_workflow.py -v
```

### Test Stub Locations

1. Frontend hook tests: `frontend/src/hooks/schema/__tests__/`
2. Frontend component tests: `frontend/src/components/flexible/__tests__/`
3. Backend API tests: `backend/tests/`

### Key Testing Patterns

**Frontend Pattern**: `renderWithProviders(component)` for React Query
**Backend Pattern**: `TestClient` for FastAPI, `db: Session` fixture for database
**Assertion Pattern**: Arrange → Act → Assert with clear comments

---

## Next Steps

1. **Review this plan** with development team
2. **Allocate 15-20 hours** of dev time (can be split across multiple developers)
3. **Start with P1 tests** (backend protection, deletion workflow)
4. **Run tests continuously** during implementation
5. **Request QA re-review** after all tests pass

**Estimated Completion**: 2-3 working days for one developer, or 1-1.5 days for two developers working in parallel on frontend/backend tests.
