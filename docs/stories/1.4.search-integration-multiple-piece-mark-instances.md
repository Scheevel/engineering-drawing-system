# Story 1.4: Search Integration for Multiple Piece Mark Instances

## Status
Draft

## Story
**As a** engineer searching for components,
**I want** the search functionality to support finding and filtering by instance_identifier,
**so that** I can locate specific instances of piece marks (e.g., "G1-A" vs "G1-B") across drawings.

## Acceptance Criteria
1. Component search results include instance_identifier field in response
2. Search API accepts instance_identifier as a filter parameter
3. Search queries can filter by specific instance_identifier values
4. Search results differentiate between multiple instances of same piece mark
5. Elasticsearch indexing includes instance_identifier field for fast searches
6. Search functionality maintains backward compatibility for components without instance_identifier
7. Advanced search supports combined filters (piece_mark + instance_identifier)

## Tasks / Subtasks
- [ ] **Task 1: Update Search API Endpoints** (AC: 1, 2, 3, 7)
  - [ ] Add instance_identifier to search response models in `backend/app/models/search.py`
  - [ ] Update search request models to accept instance_identifier filter parameter
  - [ ] Modify search endpoints in `backend/app/api/search.py` to handle instance_identifier
  - [ ] Add instance_identifier to advanced search filters
  - [ ] Test search API endpoints with instance_identifier parameters
- [ ] **Task 2: Update Elasticsearch Integration** (AC: 5, 6)
  - [ ] Update component indexing in `backend/app/services/search_service.py` to include instance_identifier
  - [ ] Modify Elasticsearch document mapping to include instance_identifier field
  - [ ] Update search queries to filter by instance_identifier when provided
  - [ ] Handle NULL instance_identifier values in search indexing
  - [ ] Re-index existing components with NULL instance_identifier for backward compatibility
- [ ] **Task 3: Update Search Service Logic** (AC: 3, 4, 6)
  - [ ] Modify SearchService methods to handle instance_identifier filtering
  - [ ] Update search result aggregation to differentiate instances
  - [ ] Ensure search results properly display instance information
  - [ ] Handle mixed scenarios (components with and without instance_identifier)
- [ ] **Task 4: Search UI Integration** (AC: 4, 7)
  - [ ] Update search forms to include instance_identifier filter input
  - [ ] Modify search results display to show instance differentiation
  - [ ] Add instance_identifier to search result cards/listings
  - [ ] Update advanced search interface with instance_identifier options
  - [ ] Test search UI with various instance_identifier scenarios

## Dev Notes

### Previous Story Dependencies
**Depends on**: 
- Story 1.1 (Database Schema Migration) - COMPLETED
- Story 1.2 (API Layer Integration) - REQUIRED

### Search Integration Specifications

**Search API Updates Required**:

**SearchRequest Model** needs:
```python
class ComponentSearchRequest(BaseModel):
    # ... existing fields ...
    instance_identifier: Optional[str] = Field(None, max_length=10, description="Filter by instance identifier")
```

**SearchResponse Model** needs:
```python
class ComponentSearchResult(BaseModel):
    # ... existing fields ...
    instance_identifier: Optional[str]
```

### Elasticsearch Integration

**Document Mapping Update**:
```json
{
  "mappings": {
    "properties": {
      "instance_identifier": {
        "type": "keyword",
        "index": true
      }
    }
  }
}
```

**Indexing Logic**:
```python
# Update component indexing to include instance_identifier
def index_component(self, component, db):
    doc = {
        # ... existing fields ...
        "instance_identifier": component.instance_identifier,
        "display_identifier": f"{component.piece_mark}-{component.instance_identifier}" if component.instance_identifier else component.piece_mark
    }
```

### Search Query Examples

**Search by Piece Mark with Instance**:
```
GET /api/v1/search/components?query=G1&instance_identifier=A
```

**Advanced Search with Multiple Filters**:
```json
{
  "query": "girder",
  "component_type": "girder",
  "instance_identifier": "A",
  "drawing_id": "uuid-here"
}
```

### File Locations
- **Search API**: `backend/app/api/search.py` - Update search endpoints
- **Search Models**: `backend/app/models/search.py` - Add instance_identifier to request/response models
- **Search Service**: `backend/app/services/search_service.py` - Update Elasticsearch integration
- **Frontend Search**: `frontend/src/components/` - Update search UI components

### Technical Constraints

**Elasticsearch Configuration**:
- Index must support instance_identifier field
- Search queries must handle NULL values gracefully
- Performance must not regress with additional field

**Search Performance Requirements**:
- Search response time < 500ms for typical queries
- Indexing time impact < 10% increase
- No regression in search relevance scoring

### Search UX Considerations

**Search Result Display**:
- Components with instance_identifier: "G1-A", "G1-B"
- Components without instance_identifier: "G1"
- Clear visual differentiation between instances

**Search Input Handling**:
- Support search for "G1-A" as combined query
- Support separate piece_mark and instance_identifier filters
- Autocomplete suggestions include instance variants

### Backend Search Service Updates

**Required Service Methods**:
```python
class SearchService:
    def search_components_with_instances(self, search_request: ComponentSearchRequest) -> ComponentSearchResponse:
        """Enhanced search supporting instance_identifier filtering"""
        
    def index_component_with_instance(self, component: Component):
        """Update component indexing to include instance_identifier"""
        
    def reindex_existing_components(self):
        """Re-index existing components with NULL instance_identifier"""
```

### Testing Requirements

**Search Integration Tests**:
- Search API with instance_identifier filters
- Elasticsearch indexing includes instance_identifier
- Search results properly differentiate instances
- Backward compatibility with existing components

**Test Scenarios**:
```python
def test_search_by_instance_identifier():
    """Test filtering search results by instance_identifier"""
    
def test_search_includes_instance_identifier_in_results():
    """Test search results include instance_identifier field"""
    
def test_elasticsearch_indexes_instance_identifier():
    """Test Elasticsearch indexing includes new field"""
    
def test_search_mixed_instance_scenarios():
    """Test search with components having and not having instance_identifier"""
```

### Migration Considerations

**Existing Data Handling**:
- Re-index all existing components with NULL instance_identifier
- Ensure backward compatibility during transition
- Monitor search performance during re-indexing

**Deployment Strategy**:
1. Update Elasticsearch mapping
2. Deploy backend search service updates
3. Re-index existing components
4. Deploy frontend search UI updates
5. Monitor search performance and accuracy

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-21 | 1.0 | Initial story creation based on QA search integration gaps | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)